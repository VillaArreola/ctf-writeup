---
import Layout from '../layouts/layout.astro';
import SearchBar from '../components/SearchBar.astro';
import { getCollection } from 'astro:content';

const ctfPosts = await getCollection('ctf');

const simplified = ctfPosts
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()) // Ordenar por fecha mÃ¡s reciente
  .map((post) => ({
    title: post.data.title,
    platform: post.data.platform,
    slug: post.slug,
    date: new Date(post.data.publishedAt).toLocaleDateString('es-MX'),
    cover: post.data.cover ?? `/images/default-cover.svg`,
    preview: post.data.preview ?? '',
    tags: post.data.tags?.join(' ') ?? ''
  }));
---

<Layout>
  <SearchBar />

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-10" x-data>
    <!-- Bento Grid: MÃ³vil uniforme, Desktop con diferentes tamaÃ±os -->
    <div class="grid grid-cols-8 gap-4 sm:gap-6">
        {simplified.map((post, i) => {
          const colSpan =
            i === 0 || i === 3 ? 'col-span-5' :
            i === 1 || i === 2 ? 'col-span-3' :
            'col-span-4';

          return (
            <a
              href={`/ctf/${post.slug}`}
              class={`group relative ${colSpan} bg-gradient-to-b from-[#16181d] to-[#0d0e10] rounded-2xl p-3 sm:p-4 md:p-6 shadow-xl hover:scale-[1.01] transition duration-200 border border-gray-800 hover:border-cyan-400`}
              data-title={post.title}
              data-platform={post.platform}
              data-tags={post.tags}
              data-preview={post.preview}
              x-show="`${$el.dataset.title} ${$el.dataset.platform} ${$el.dataset.tags} ${$el.dataset.preview}`.toLowerCase().includes($store.search.query.toLowerCase())"
            >
              {/* Imagen de portada */}
              <img
                src={post.cover}
                alt={`Portada de ${post.title}`}
                class="w-full h-32 sm:h-40 md:h-48 object-cover rounded mb-3 sm:mb-4"
              />
              
              {/* TÃ­tulo y plataforma */}
              <div class="mb-3 sm:mb-4">
                <h3 class="text-sm sm:text-base md:text-lg font-semibold text-white group-hover:text-cyan-400 transition">
                  {post.title}
                </h3>
                <p class="text-xs sm:text-sm text-gray-400">
                  {post.platform} â€” {post.date}
                </p>
              </div>

              {/* DescripciÃ³n y etiquetas */}
              <div class="flex flex-col sm:flex-row sm:justify-between gap-2 sm:gap-3 md:gap-4 text-xs sm:text-sm text-gray-400 leading-relaxed">
                <div class="sm:w-1/2 sm:pr-4 md:pr-6 sm:border-r sm:border-gray-700 text-gray-200 bg-black/30 p-2 sm:p-3 rounded-md">
                  <div class="line-clamp-2 sm:line-clamp-3 md:line-clamp-none">
                    {post.preview || 'Este writeup aÃºn no tiene descripciÃ³n. ðŸš§'}
                  </div>
                </div>

                <div class="sm:w-1/2 sm:pl-4 md:pl-6 flex flex-wrap gap-x-1 sm:gap-x-2 gap-y-1 sm:gap-y-2 md:gap-y-3 sm:justify-start sm:items-start self-start">
                  {post.tags ? (
                    post.tags.split(' ').map(tag => {
                      const tagColors = {
                        THM: 'bg-purple-600',
                        HTB: 'bg-red-600',
                        CiberLabs: 'bg-orange-600',
                        Default: 'bg-cyan-800'
                      };
                      const color = tagColors[tag] || tagColors.Default;

                      return (
                        <span
                          class={`text-white px-1.5 sm:px-2 py-0.5 rounded-full text-xs whitespace-nowrap hover:brightness-110 transition duration-200 ${color}`}
                        >
                          ðŸ”– {tag}
                        </span>
                      );
                    })
                  ) : (
                    <span class="text-gray-500 italic text-xs sm:text-sm">Sin etiquetas</span>
                  )}
                </div>
              </div>
            </a>
          );
        })}
      </div>

      {/* Sin resultados */}
      <p
        class="text-sm text-gray-500 mt-6"
        x-show="!Array.from($el.previousElementSibling.children).some(el => el.offsetParent !== null) && $store.search.query"
      >
        ðŸ˜¢ No se encontraron resultados para "<span x-text="$store.search.query"></span>".
      </p>
    </main>
</Layout>
